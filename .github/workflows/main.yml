name: CI/CD Pipeline

on:
  push:
    branches:
      - main

jobs:
  build_project:
    runs-on: self-hosted

    steps:
    - name: Checkout code
      uses: actions/checkout@v2
      
    - name: Set up JDK 17
      uses: actions/setup-java@v2
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: Install Maven
      run: sudo apt-get update && sudo apt-get install -y maven

    - name: Build project
      run: mvn install -Dmaven.test.skip=true

  build_and_push_image:
    runs-on: self-hosted

    needs: build_project
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Build Docker image
      run: docker build -t your-dockerhub-username/your-repo-name:latest .

    - name: Log in to Docker Hub
      run: echo "${{ secrets.DOCKER_HUB_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_HUB_USERNAME }}" --password-stdin

    - name: Push Docker image
      run: docker push your-dockerhub-username/your-repo-name:latest

  deploy:
    runs-on: self-hosted

    needs: build_and_push_image

    steps:
    - name: Deploy to Kubernetes
      run: |
        ssh -o StrictHostKeyChecking=no -i ${{ secrets.SSH_PRIVATE_KEY }} ubuntu@instance2-public-ip << 'EOF'
          kubectl set image deployment/your-deployment your-container=your-dockerhub-username/your-repo-name:latest --record
          kubectl rollout status deployment/your-deployment
        EOF