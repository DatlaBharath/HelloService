{"pipeline":{"name":"build-deploy","identifier":"build","projectIdentifier":"default_project","orgIdentifier":"default","tags":{},"stages":[{"stage":{"name":"Build and Deploy","identifier":"Build_And_Deploy","type":"Custom","spec":{"execution":{"steps":[{"step":{"name":"Checkout Code","identifier":"Checkout_Code","type":"ShellScript","spec":{"shell":"Bash","source":{"type":"Inline","spec":{"script":"echo \"Cloning repo...\"\nrm -rf my-repo\ngit clone https://github.com/username/my-repo.git\ncd my-repo\ngit checkout main\npwd\nls\n"}},"executionTarget":{},"environmentVariables":[],"outputVariables":[]},"timeout":"10m"}},{"step":{"name":"Build Project","identifier":"Build_Project","type":"ShellScript","spec":{"shell":"Bash","onDelegate":true,"source":{"type":"Inline","spec":{"script":"cd my-repo\nmvn clean install -DskipTests\n"}}}}},{"step":{"name":"Build Docker Image","identifier":"Build_Image","type":"ShellScript","spec":{"shell":"Bash","onDelegate":true,"source":{"type":"Inline","spec":{"script":"cd my-repo\ndocker build -t sakthisiddu1/my-repo:<+pipeline.sequenceId> .\n"}}}}},{"step":{"name":"Push Docker Image","identifier":"Push_Image","type":"ShellScript","spec":{"shell":"Bash","onDelegate":true,"environmentVariables":[{"name":"DOCKERHUB_USERNAME","type":"String","value":"<+secrets.getValue(\"dockerhub-username\")>"},{"name":"DOCKERHUB_PASSWORD","type":"String","value":"<+secrets.getValue(\"dockerhub-password\")>"}],"source":{"type":"Inline","spec":{"script":"echo \"$DOCKERHUB_USERNAME\" | docker login -u \"$DOCKERHUB_USERNAME\" --password-stdin\ndocker push sakthisiddu1/my-repo:<+pipeline.sequenceId>\n"}}}}},{"step":{"name":"Deploy to Kubernetes via SSH","identifier":"Deploy_K8s","type":"ShellScript","spec":{"shell":"Bash","onDelegate":true,"source":{"type":"Inline","spec":{"script":"echo \"Creating deployment.yaml and service.yaml...\"\n\ncat <<EOF > deployment.yaml\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: my-repo-deployment\nspec:\n  replicas: 2\n  selector:\n    matchLabels:\n      app: my-repo\n  template:\n    metadata:\n      labels:\n        app: my-repo\n    spec:\n      containers:\n      - name: my-repo\n        image: sakthisiddu1/my-repo:<+pipeline.sequenceId>\n        ports:\n        - containerPort: 5000\nEOF\n\ncat <<EOF > service.yaml\napiVersion: v1\nkind: Service\nmetadata:\n  name: my-repo-service\nspec:\n  type: NodePort\n  selector:\n    app: my-repo\n  ports:\n    - port: 5000\n      targetPort: 5000\n      nodePort: 30007\nEOF\n\necho \"Deploying to Kubernetes via SSH...\"\n\nssh -o StrictHostKeyChecking=no -i /home/harness/.ssh/test.pem ubuntu@13.201.55.146 \"kubectl apply -f -\" < deployment.yaml\nssh -o StrictHostKeyChecking=no -i /home/harness/.ssh/test.pem ubuntu@13.201.55.146 \"kubectl apply -f -\" < service.yaml\n\nrm -rf my-repo\n"}}}}}]}}}}]}}